# =================================================================
# .htaccess - Server-Level Configuration
# Bob and Mariel Ward School of Filipino Languages
# =================================================================

# =================================================================
# FORCE HTTPS - Server Level Enforcement
# =================================================================
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Force HTTPS (handles both direct requests and requests behind proxy)
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# =================================================================
# SECURITY HEADERS - HSTS and Other Security Headers
# =================================================================
<IfModule mod_headers.c>
    # HTTP Strict Transport Security (HSTS) - Force HTTPS for 1 year
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS

    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Clickjacking protection
    Header always set X-Frame-Options "SAMEORIGIN"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# =================================================================
# CRITICAL: PREVENT CACHING OF ASSET MANAGEMENT ENDPOINTS
# =================================================================

<IfModule mod_headers.c>
    # Prevent caching of asset-related API endpoints
    <FilesMatch "(list-assets|scan-assets|rename-asset)\.php$">
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "Thu, 01 Jan 1970 00:00:00 GMT"
    </FilesMatch>

    # Prevent caching of manifest.json
    <Files "manifest.json">
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "Thu, 01 Jan 1970 00:00:00 GMT"
    </Files>

    # Prevent caching of CSV files in assets folder
    <FilesMatch "\.(csv)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "Thu, 01 Jan 1970 00:00:00 GMT"
    </FilesMatch>
</IfModule>

# =================================================================
# PREVENT CACHING OF CSS AND JAVASCRIPT FILES
# =================================================================
# Force browsers to check version via query string parameters

<IfModule mod_headers.c>
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "no-cache, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
    </FilesMatch>
</IfModule>

# =================================================================
# ALLOW NORMAL CACHING FOR ACTUAL MEDIA ASSETS
# =================================================================
# We want images and audio to be cached normally for performance
# Only prevent caching of the LISTS and MANAGEMENT endpoints

<IfModule mod_headers.c>
    # Allow caching of image, video, and audio files (actual learning assets)
    <FilesMatch "\.(png|jpg|jpeg|webp|gif|mp4|webm|mp3|m4a)$">
        # These can be cached for performance
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
</IfModule>

# =================================================================
# SECURITY: PREVENT DIRECTORY LISTING
# =================================================================
Options -Indexes

# =================================================================
# SECURITY: PROTECT SENSITIVE FILES
# =================================================================
<FilesMatch "(\.htaccess|\.htpasswd|\.env|\.git)">
    Require all denied
</FilesMatch>

# =================================================================
# PHP SETTINGS (if needed)
# =================================================================
<IfModule mod_php.c>
    # Increase upload size limits for media files
    php_value upload_max_filesize 100M
    php_value post_max_size 100M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>