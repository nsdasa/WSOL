<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSOL TTS Generator - ElevenLabs</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .config-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .config-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .config-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .panel {
            display: none;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .panel.active {
            display: block;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            min-width: 150px;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        .item-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .item-card:hover {
            border-color: var(--primary);
        }

        .item-card.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .item-card.has-audio {
            border-left: 4px solid var(--success);
        }

        .item-card .word {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .item-card .english {
            color: var(--text-light);
            font-size: 14px;
        }

        .item-card .meta {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
            display: flex;
            gap: 10px;
        }

        .item-card .meta span {
            background: var(--border);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .sentence-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }

        .selection-info {
            flex: 1;
            font-weight: 600;
            color: var(--text-light);
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
        }

        .log-container {
            margin-top: 20px;
            background: #1e293b;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }

        .log-entry {
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .log-entry.success {
            color: #4ade80;
        }

        .log-entry.error {
            color: #f87171;
        }

        .log-entry.info {
            color: #60a5fa;
        }

        .audio-preview {
            margin-top: 15px;
        }

        .audio-preview audio {
            width: 100%;
        }

        .voice-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .voice-option {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-option:hover {
            border-color: var(--primary);
        }

        .voice-option.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .voice-option .name {
            font-weight: 600;
        }

        .voice-option .labels {
            font-size: 12px;
            color: var(--text-light);
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        .batch-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .rate-limit-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .auth-box h2 {
            color: var(--danger);
            margin-bottom: 20px;
        }

        .auth-box p {
            color: var(--text);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .auth-box .btn-primary {
            padding: 14px 28px;
            font-size: 16px;
        }

        .main-content {
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }

        .user-info {
            text-align: right;
            padding: 10px 20px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: var(--text-light);
        }

        .user-info strong {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <!-- Auth Required Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-box">
            <h2>Authentication Required</h2>
            <p id="authMessage">This tool requires Admin access. Please log in from the main application first.</p>
            <button class="btn-primary" onclick="window.location.href='../'">Go to Main App</button>
        </div>
    </div>

    <div class="container main-content" id="mainContent">
        <h1>WSOL TTS Generator</h1>

        <!-- User Info -->
        <div class="user-info" id="userInfo">
            Logged in as: <strong id="usernameDisplay">-</strong>
        </div>

        <!-- API Configuration -->
        <div class="config-panel">
            <h3 style="margin-bottom: 15px;">ElevenLabs Configuration</h3>
            <div class="config-row">
                <div class="config-group">
                    <label for="apiKey">API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your ElevenLabs API key">
                </div>
                <div class="config-group">
                    <label for="voiceFilter">Voice Filter</label>
                    <select id="voiceFilter" onchange="filterVoices()">
                        <option value="all">All Voices</option>
                        <option value="filipino">Filipino/Tagalog</option>
                        <option value="cebuano">Cebuano</option>
                        <option value="asian">Asian Languages</option>
                    </select>
                </div>
                <div class="config-group">
                    <label for="voiceSelect">Voice</label>
                    <select id="voiceSelect">
                        <option value="">-- Load voices first --</option>
                    </select>
                </div>
                <div class="config-group" style="flex: 0;">
                    <label>&nbsp;</label>
                    <button class="btn-primary" onclick="loadVoices()">Load Voices</button>
                </div>
            </div>
            <div class="config-row" style="margin-top: 15px;">
                <div class="config-group">
                    <label for="modelSelect">Model</label>
                    <select id="modelSelect">
                        <option value="eleven_multilingual_v2">Multilingual v2 (Best)</option>
                        <option value="eleven_turbo_v2_5">Turbo v2.5 (Fast)</option>
                        <option value="eleven_turbo_v2">Turbo v2</option>
                        <option value="eleven_monolingual_v1">Monolingual v1</option>
                    </select>
                </div>
                <div class="config-group">
                    <label for="outputFormat">Output Format</label>
                    <select id="outputFormat">
                        <option value="opus">OPUS (Recommended)</option>
                        <option value="mp3">MP3 (Fallback)</option>
                    </select>
                </div>
                <div class="config-group">
                    <label for="stability">Stability: <span id="stabilityVal">0.5</span></label>
                    <input type="range" id="stability" min="0" max="1" step="0.1" value="0.5" oninput="document.getElementById('stabilityVal').textContent = this.value">
                </div>
                <div class="config-group">
                    <label for="similarity">Similarity Boost: <span id="similarityVal">0.75</span></label>
                    <input type="range" id="similarity" min="0" max="1" step="0.1" value="0.75" oninput="document.getElementById('similarityVal').textContent = this.value">
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="config-panel" id="systemStatus" style="display: none;">
            <h3 style="margin-bottom: 15px;">System Status</h3>
            <div id="statusContent"></div>
        </div>

        <!-- Rate Limit Info -->
        <div class="rate-limit-info">
            <strong>Note:</strong> ElevenLabs has rate limits. Processing includes a 1-second delay between requests to avoid hitting limits.
        </div>

        <!-- Filipino Voice Tips -->
        <div class="rate-limit-info" style="background: #e0f2fe; border-color: #0284c7;">
            <strong>Filipino/Cebuano Tips:</strong>
            <ul style="margin: 5px 0 0 20px; font-size: 13px;">
                <li><strong>Model:</strong> Use "Multilingual v2" - it supports Filipino (Tagalog) and can handle Cebuano reasonably well</li>
                <li><strong>Voice Filter:</strong> Try "Filipino/Tagalog" to find voices with Filipino accents from the Voice Library</li>
                <li><strong>Any Voice Works:</strong> With Multilingual v2, any voice can speak Filipino text - the model handles pronunciation</li>
                <li><strong>Cebuano:</strong> No dedicated Cebuano voices exist, but Multilingual v2 handles it through its general multilingual capability</li>
            </ul>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('words')">Words</div>
            <div class="tab" onclick="switchTab('sentences')">Sentences</div>
            <div class="tab" onclick="switchTab('custom')">Custom Text</div>
        </div>

        <!-- Words Panel -->
        <div id="wordsPanel" class="panel active">
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="totalWordsCount">0</div>
                    <div class="stat-label">Total Words</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="withAudioCount">0</div>
                    <div class="stat-label">With Audio</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="needAudioCount">0</div>
                    <div class="stat-label">Need Audio</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label for="wordLang">Language</label>
                    <select id="wordLang" onchange="filterWords()">
                        <option value="ceb">Cebuano</option>
                        <option value="mrw">Maranao</option>
                        <option value="sin">Sinama</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="wordLesson">Lesson</label>
                    <select id="wordLesson" onchange="filterWords()">
                        <option value="all">All Lessons</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="wordFilter">Filter</label>
                    <select id="wordFilter" onchange="filterWords()">
                        <option value="all">All Words</option>
                        <option value="no-audio">Without Audio</option>
                        <option value="has-audio">With Audio</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="wordSearch">Search</label>
                    <input type="text" id="wordSearch" placeholder="Search words..." oninput="filterWords()">
                </div>
            </div>

            <div class="item-grid" id="wordsGrid"></div>

            <div class="action-bar">
                <div class="selection-info">
                    <span id="selectedCount">0</span> words selected
                </div>
                <div class="batch-controls">
                    <button class="btn-primary" onclick="selectAllVisible()">Select All Visible</button>
                    <button class="btn-warning" onclick="selectWithoutAudio()">Select Without Audio</button>
                    <button class="btn-danger" onclick="clearSelection()">Clear Selection</button>
                    <button class="btn-success" onclick="generateSelected()" id="generateBtn">Generate Audio</button>
                </div>
            </div>
        </div>

        <!-- Sentences Panel -->
        <div id="sentencesPanel" class="panel">
            <div class="filters">
                <div class="filter-group">
                    <label for="sentLang">Language</label>
                    <select id="sentLang" onchange="filterSentences()">
                        <option value="ceb">Cebuano</option>
                        <option value="mrw">Maranao</option>
                        <option value="sin">Sinama</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sentLesson">Lesson</label>
                    <select id="sentLesson" onchange="filterSentences()">
                        <option value="all">All Lessons</option>
                    </select>
                </div>
            </div>

            <div class="item-grid" id="sentencesGrid"></div>

            <div class="action-bar">
                <div class="selection-info">
                    <span id="selectedSentCount">0</span> sentences selected
                </div>
                <div class="batch-controls">
                    <button class="btn-primary" onclick="selectAllSentences()">Select All Visible</button>
                    <button class="btn-danger" onclick="clearSentenceSelection()">Clear Selection</button>
                    <button class="btn-success" onclick="generateSelectedSentences()">Generate Audio</button>
                </div>
            </div>
        </div>

        <!-- Custom Text Panel -->
        <div id="customPanel" class="panel">
            <div class="config-row">
                <div class="config-group" style="flex: 2;">
                    <label for="customText">Text to Synthesize</label>
                    <textarea id="customText" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px;" placeholder="Enter text to convert to speech..."></textarea>
                </div>
            </div>
            <div class="config-row" style="margin-top: 15px;">
                <div class="config-group">
                    <label for="customFilename">Filename (without extension)</label>
                    <input type="text" id="customFilename" placeholder="e.g., custom-audio-1">
                </div>
                <div class="config-group">
                    <label for="customLang">Save to Language Folder</label>
                    <select id="customLang">
                        <option value="">Root assets folder</option>
                        <option value="ceb">Cebuano (sentences)</option>
                        <option value="mrw">Maranao (sentences)</option>
                        <option value="sin">Sinama (sentences)</option>
                    </select>
                </div>
                <div class="config-group" style="flex: 0;">
                    <label>&nbsp;</label>
                    <button class="btn-success" onclick="generateCustom()">Generate & Save</button>
                </div>
            </div>
            <div class="audio-preview" id="customPreview"></div>
        </div>

        <!-- Progress -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Processing...</div>
        </div>

        <!-- Log -->
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        // Global state
        let manifest = null;
        let selectedWords = new Set();
        let selectedSentences = new Set();
        let voices = [];
        let isProcessing = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const authOk = await checkAuthentication();
            if (!authOk) {
                return; // Stop initialization if not authenticated
            }

            // Load saved API key
            const savedKey = localStorage.getItem('elevenlabs_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }

            // Check system status
            await checkSystemStatus();

            // Load manifest
            await loadManifest();
            log('Manifest loaded successfully', 'success');
        });

        // Check if user is authenticated as Admin
        async function checkAuthentication() {
            try {
                const response = await fetch('check-auth.php');
                const data = await response.json();

                if (data.authenticated) {
                    // Show main content, hide overlay
                    document.getElementById('authOverlay').style.display = 'none';
                    document.getElementById('mainContent').classList.add('authenticated');
                    document.getElementById('usernameDisplay').textContent = data.username || 'Admin';
                    return true;
                } else {
                    // Show auth error
                    document.getElementById('authMessage').textContent = data.error || 'Authentication required.';
                    document.getElementById('authOverlay').style.display = 'flex';
                    return false;
                }
            } catch (error) {
                document.getElementById('authMessage').textContent = 'Could not verify authentication. Please try again.';
                document.getElementById('authOverlay').style.display = 'flex';
                return false;
            }
        }

        // Handle auth errors from API responses
        function handleAuthError(result) {
            if (result.requiresAuth) {
                document.getElementById('authMessage').textContent = result.error || 'Session expired. Please log in again.';
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('mainContent').classList.remove('authenticated');
                return true;
            }
            return false;
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('status.php');
                const status = await response.json();

                const statusPanel = document.getElementById('systemStatus');
                const statusContent = document.getElementById('statusContent');

                let html = '<div style="display: flex; gap: 20px; flex-wrap: wrap;">';

                // ffmpeg status
                const ffmpegOk = status.ffmpeg?.available;
                html += `<div style="padding: 10px; border-radius: 8px; background: ${ffmpegOk ? '#dcfce7' : '#fef3c7'};">
                    <strong>ffmpeg:</strong> ${ffmpegOk ? 'Available' : 'Not found'}
                    ${ffmpegOk && status.ffmpeg.version ? `<br><small>v${status.ffmpeg.version}</small>` : ''}
                </div>`;

                // Directories status
                const dirsOk = status.directories?.assets_writable;
                html += `<div style="padding: 10px; border-radius: 8px; background: ${dirsOk ? '#dcfce7' : '#fee2e2'};">
                    <strong>Assets Dir:</strong> ${dirsOk ? 'Writable' : 'Not writable'}
                </div>`;

                // Overall status
                html += `<div style="padding: 10px; border-radius: 8px; background: ${status.ready ? '#dcfce7' : '#fee2e2'};">
                    <strong>Status:</strong> ${status.ready ? 'Ready' : 'Issues detected'}
                </div>`;

                html += '</div>';

                // Show recommendations if any
                if (status.recommendations?.length > 0) {
                    html += '<div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 8px;">';
                    html += '<strong>Recommendations:</strong><ul style="margin: 5px 0 0 20px;">';
                    status.recommendations.forEach(rec => {
                        html += `<li>${rec}</li>`;
                    });
                    html += '</ul></div>';
                }

                // If ffmpeg not available, force MP3 format
                if (!ffmpegOk) {
                    document.getElementById('outputFormat').value = 'mp3';
                    log('ffmpeg not available - defaulting to MP3 format', 'info');
                }

                statusContent.innerHTML = html;
                statusPanel.style.display = 'block';

            } catch (error) {
                log('Could not check system status: ' + error.message, 'error');
            }
        }

        async function loadManifest() {
            try {
                const response = await fetch('../assets/manifest.json');
                manifest = await response.json();
                populateLessonFilters();
                filterWords();
                filterSentences();
            } catch (error) {
                log('Error loading manifest: ' + error.message, 'error');
            }
        }

        function populateLessonFilters() {
            const langs = ['ceb', 'mrw', 'sin'];
            langs.forEach(lang => {
                const lessons = new Set();
                if (manifest.cards[lang]) {
                    manifest.cards[lang].forEach(card => lessons.add(card.lesson));
                }
            });

            // Populate word lesson filter
            const wordLesson = document.getElementById('wordLesson');
            wordLesson.innerHTML = '<option value="all">All Lessons</option>';
            for (let i = 1; i <= 15; i++) {
                wordLesson.innerHTML += `<option value="${i}">Lesson ${i}</option>`;
            }

            // Populate sentence lesson filter
            const sentLesson = document.getElementById('sentLesson');
            sentLesson.innerHTML = '<option value="all">All Lessons</option>';
            for (let i = 1; i <= 15; i++) {
                sentLesson.innerHTML += `<option value="${i}">Lesson ${i}</option>`;
            }
        }

        async function loadVoices() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                log('Please enter your API key first', 'error');
                return;
            }

            // Save API key
            localStorage.setItem('elevenlabs_api_key', apiKey);

            try {
                log('Loading voices from ElevenLabs...', 'info');
                const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                    headers: {
                        'xi-api-key': apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load voices: ' + response.statusText);
                }

                const data = await response.json();
                voices = data.voices;

                // Also try to get shared voices for Filipino languages
                try {
                    const sharedResponse = await fetch('https://api.elevenlabs.io/v1/shared-voices?page_size=100&language=fil', {
                        headers: {
                            'xi-api-key': apiKey
                        }
                    });
                    if (sharedResponse.ok) {
                        const sharedData = await sharedResponse.json();
                        if (sharedData.voices) {
                            // Mark shared voices and add to list
                            sharedData.voices.forEach(v => {
                                v.isShared = true;
                                v.labels = v.labels || {};
                                v.labels.source = 'Voice Library';
                                v.labels.language = 'Filipino';
                            });
                            voices = voices.concat(sharedData.voices);
                        }
                    }
                } catch (e) {
                    // Shared voices optional, continue without
                }

                filterVoices();
                log(`Loaded ${voices.length} voices`, 'success');
            } catch (error) {
                log('Error loading voices: ' + error.message, 'error');
            }
        }

        // Filter voices based on language selection
        function filterVoices() {
            const filter = document.getElementById('voiceFilter').value;
            const select = document.getElementById('voiceSelect');
            select.innerHTML = '<option value="">-- Select a voice --</option>';

            if (!voices || voices.length === 0) {
                return;
            }

            // Keywords to match for each filter
            const filterKeywords = {
                'filipino': ['filipino', 'tagalog', 'philippines', 'fil', 'tl'],
                'cebuano': ['cebuano', 'bisaya', 'visayan', 'ceb'],
                'asian': ['filipino', 'tagalog', 'cebuano', 'asian', 'chinese', 'japanese', 'korean', 'vietnamese', 'thai', 'indonesian', 'malay']
            };

            let filteredVoices = voices;

            if (filter !== 'all' && filterKeywords[filter]) {
                const keywords = filterKeywords[filter];
                filteredVoices = voices.filter(voice => {
                    // Check voice name
                    const nameLower = voice.name.toLowerCase();
                    if (keywords.some(kw => nameLower.includes(kw))) return true;

                    // Check labels
                    if (voice.labels) {
                        const labelValues = Object.values(voice.labels).map(v => String(v).toLowerCase());
                        const labelKeys = Object.keys(voice.labels).map(k => k.toLowerCase());
                        const allLabels = [...labelValues, ...labelKeys].join(' ');
                        if (keywords.some(kw => allLabels.includes(kw))) return true;
                    }

                    // Check description if available
                    if (voice.description) {
                        const descLower = voice.description.toLowerCase();
                        if (keywords.some(kw => descLower.includes(kw))) return true;
                    }

                    // Check fine_tuning language if available
                    if (voice.fine_tuning?.language) {
                        const ftLang = voice.fine_tuning.language.toLowerCase();
                        if (keywords.some(kw => ftLang.includes(kw))) return true;
                    }

                    return false;
                });
            }

            // Sort: prioritize voices with relevant language labels
            filteredVoices.sort((a, b) => {
                const aHasLang = a.labels?.language || a.labels?.accent || '';
                const bHasLang = b.labels?.language || b.labels?.accent || '';
                if (aHasLang && !bHasLang) return -1;
                if (!aHasLang && bHasLang) return 1;
                return a.name.localeCompare(b.name);
            });

            filteredVoices.forEach(voice => {
                const labelParts = [];
                if (voice.labels) {
                    if (voice.labels.language) labelParts.push(voice.labels.language);
                    if (voice.labels.accent) labelParts.push(voice.labels.accent);
                    if (voice.labels.gender) labelParts.push(voice.labels.gender);
                    if (voice.labels.age) labelParts.push(voice.labels.age);
                    if (voice.labels.source) labelParts.push(voice.labels.source);
                }
                const labelStr = labelParts.length > 0 ? ` (${labelParts.join(', ')})` : '';
                select.innerHTML += `<option value="${voice.voice_id}">${voice.name}${labelStr}</option>`;
            });

            if (filteredVoices.length === 0) {
                select.innerHTML = '<option value="">-- No matching voices found --</option>';
                log(`No voices found matching "${filter}" filter. Try "All Voices" and use Multilingual v2 model.`, 'info');
            } else {
                log(`Showing ${filteredVoices.length} voices for "${filter}" filter`, 'info');
            }
        }

        function filterWords() {
            const lang = document.getElementById('wordLang').value;
            const lesson = document.getElementById('wordLesson').value;
            const filter = document.getElementById('wordFilter').value;
            const search = document.getElementById('wordSearch').value.toLowerCase();

            if (!manifest || !manifest.cards[lang]) {
                document.getElementById('wordsGrid').innerHTML = '<p>No words found</p>';
                return;
            }

            let words = manifest.cards[lang];

            // Filter by lesson
            if (lesson !== 'all') {
                words = words.filter(w => w.lesson === parseInt(lesson));
            }

            // Filter by audio status
            if (filter === 'no-audio') {
                words = words.filter(w => !w.hasAudio);
            } else if (filter === 'has-audio') {
                words = words.filter(w => w.hasAudio);
            }

            // Filter by search
            if (search) {
                words = words.filter(w =>
                    w.word.toLowerCase().includes(search) ||
                    w.english.toLowerCase().includes(search)
                );
            }

            // Update stats
            const allWords = manifest.cards[lang];
            const withAudio = allWords.filter(w => w.hasAudio).length;
            document.getElementById('totalWordsCount').textContent = allWords.length;
            document.getElementById('withAudioCount').textContent = withAudio;
            document.getElementById('needAudioCount').textContent = allWords.length - withAudio;

            // Render grid
            const grid = document.getElementById('wordsGrid');
            grid.innerHTML = '';

            words.forEach(word => {
                const isSelected = selectedWords.has(`${lang}-${word.cardNum}`);
                const card = document.createElement('div');
                card.className = `item-card ${isSelected ? 'selected' : ''} ${word.hasAudio ? 'has-audio' : ''}`;
                card.dataset.key = `${lang}-${word.cardNum}`;
                card.onclick = () => toggleWordSelection(lang, word.cardNum);

                card.innerHTML = `
                    <div class="word">${word.word}</div>
                    <div class="english">${word.english}</div>
                    <div class="meta">
                        <span>Card #${word.cardNum}</span>
                        <span>Lesson ${word.lesson}</span>
                        <span>${word.category || 'N/A'}</span>
                        ${word.hasAudio ? '<span style="background: #dcfce7; color: #166534;">Has Audio</span>' : ''}
                    </div>
                `;

                grid.appendChild(card);
            });

            updateSelectionCount();
        }

        function filterSentences() {
            const lang = document.getElementById('sentLang').value;
            const lesson = document.getElementById('sentLesson').value;

            const grid = document.getElementById('sentencesGrid');
            grid.innerHTML = '';

            if (!manifest || !manifest.sentenceReview || !manifest.sentenceReview[lang]) {
                grid.innerHTML = '<p>No sentences found for this language</p>';
                return;
            }

            const langData = manifest.sentenceReview[lang];
            if (!langData.lessons) {
                grid.innerHTML = '<p>No lesson data found</p>';
                return;
            }

            let allSentences = [];

            Object.entries(langData.lessons).forEach(([lessonNum, lessonData]) => {
                if (lesson !== 'all' && lessonNum !== lesson) return;

                if (lessonData.sequences) {
                    lessonData.sequences.forEach((seq, seqIdx) => {
                        if (seq.sentences) {
                            seq.sentences.forEach((sent, sentIdx) => {
                                allSentences.push({
                                    ...sent,
                                    lesson: lessonNum,
                                    sequenceId: seq.id,
                                    sequenceTitle: seq.title,
                                    uniqueId: `${lang}-${lessonNum}-${seqIdx}-${sentIdx}`
                                });
                            });
                        }
                    });
                }
            });

            allSentences.forEach(sent => {
                const isSelected = selectedSentences.has(sent.uniqueId);
                const card = document.createElement('div');
                card.className = `item-card ${isSelected ? 'selected' : ''}`;
                card.dataset.key = sent.uniqueId;
                card.onclick = () => toggleSentenceSelection(sent.uniqueId);

                card.innerHTML = `
                    <div class="sentence-text">${sent.text}</div>
                    <div class="english">${sent.english}</div>
                    <div class="meta">
                        <span>Lesson ${sent.lesson}</span>
                        <span>${sent.sequenceTitle || ''}</span>
                        <span>${sent.sentenceType || ''}</span>
                    </div>
                `;

                grid.appendChild(card);
            });

            if (allSentences.length === 0) {
                grid.innerHTML = '<p>No sentences found</p>';
            }

            updateSentenceSelectionCount();
        }

        function toggleWordSelection(lang, cardNum) {
            const key = `${lang}-${cardNum}`;
            if (selectedWords.has(key)) {
                selectedWords.delete(key);
            } else {
                selectedWords.add(key);
            }

            const card = document.querySelector(`[data-key="${key}"]`);
            if (card) {
                card.classList.toggle('selected');
            }

            updateSelectionCount();
        }

        function toggleSentenceSelection(uniqueId) {
            if (selectedSentences.has(uniqueId)) {
                selectedSentences.delete(uniqueId);
            } else {
                selectedSentences.add(uniqueId);
            }

            const card = document.querySelector(`[data-key="${uniqueId}"]`);
            if (card) {
                card.classList.toggle('selected');
            }

            updateSentenceSelectionCount();
        }

        function selectAllVisible() {
            const cards = document.querySelectorAll('#wordsGrid .item-card');
            cards.forEach(card => {
                const key = card.dataset.key;
                selectedWords.add(key);
                card.classList.add('selected');
            });
            updateSelectionCount();
        }

        function selectWithoutAudio() {
            const lang = document.getElementById('wordLang').value;
            const words = manifest.cards[lang].filter(w => !w.hasAudio);

            words.forEach(word => {
                const key = `${lang}-${word.cardNum}`;
                selectedWords.add(key);
            });

            filterWords(); // Refresh display
            updateSelectionCount();
        }

        function clearSelection() {
            selectedWords.clear();
            document.querySelectorAll('#wordsGrid .item-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateSelectionCount();
        }

        function selectAllSentences() {
            const cards = document.querySelectorAll('#sentencesGrid .item-card');
            cards.forEach(card => {
                const key = card.dataset.key;
                selectedSentences.add(key);
                card.classList.add('selected');
            });
            updateSentenceSelectionCount();
        }

        function clearSentenceSelection() {
            selectedSentences.clear();
            document.querySelectorAll('#sentencesGrid .item-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateSentenceSelectionCount();
        }

        function updateSelectionCount() {
            document.getElementById('selectedCount').textContent = selectedWords.size;
        }

        function updateSentenceSelectionCount() {
            document.getElementById('selectedSentCount').textContent = selectedSentences.size;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            document.querySelector(`.tab:nth-child(${tab === 'words' ? 1 : tab === 'sentences' ? 2 : 3})`).classList.add('active');
            document.getElementById(`${tab}Panel`).classList.add('active');
        }

        function log(message, type = '') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function showProgress(show) {
            document.getElementById('progressContainer').classList.toggle('visible', show);
        }

        function updateProgress(current, total, message) {
            const percent = (current / total) * 100;
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${message} (${current}/${total})`;
        }

        async function generateSelected() {
            if (isProcessing) {
                log('Already processing, please wait...', 'error');
                return;
            }

            if (selectedWords.size === 0) {
                log('No words selected', 'error');
                return;
            }

            const apiKey = document.getElementById('apiKey').value.trim();
            const voiceId = document.getElementById('voiceSelect').value;

            if (!apiKey) {
                log('Please enter your API key', 'error');
                return;
            }

            if (!voiceId) {
                log('Please select a voice', 'error');
                return;
            }

            isProcessing = true;
            showProgress(true);

            const wordList = Array.from(selectedWords).map(key => {
                const [lang, cardNum] = key.split('-');
                const card = manifest.cards[lang].find(c => c.cardNum === parseInt(cardNum));
                return { lang, cardNum: parseInt(cardNum), word: card.word, english: card.english };
            });

            log(`Starting batch generation for ${wordList.length} words...`, 'info');

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < wordList.length; i++) {
                const item = wordList[i];
                updateProgress(i + 1, wordList.length, `Processing: ${item.word}`);

                try {
                    const result = await generateWordAudio(item, apiKey, voiceId);
                    if (result.success) {
                        successCount++;
                        const formatInfo = result.format ? ` [${result.format}]` : '';
                        log(`Generated: ${item.word} -> ${result.filename}${formatInfo}`, 'success');
                    } else {
                        errorCount++;
                        log(`Failed: ${item.word} - ${result.error}`, 'error');
                    }
                } catch (error) {
                    errorCount++;
                    log(`Error: ${item.word} - ${error.message}`, 'error');
                }

                // Rate limit delay
                if (i < wordList.length - 1) {
                    await sleep(1000);
                }
            }

            showProgress(false);
            isProcessing = false;
            log(`Batch complete: ${successCount} success, ${errorCount} errors`, successCount > 0 ? 'success' : 'error');

            // Refresh to show updated audio status
            await loadManifest();
        }

        async function generateWordAudio(item, apiKey, voiceId) {
            const model = document.getElementById('modelSelect').value;
            const stability = parseFloat(document.getElementById('stability').value);
            const similarity = parseFloat(document.getElementById('similarity').value);
            const outputFormat = document.getElementById('outputFormat').value;

            // Generate filename: {cardNum}.{lang}.{word_lowercase}.{format}
            const cleanWord = item.word.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/[^a-z0-9]/g, '-')      // Replace non-alphanumeric
                .replace(/-+/g, '-')             // Collapse multiple dashes
                .replace(/^-|-$/g, '');          // Remove leading/trailing dashes

            const filename = `${item.cardNum}.${item.lang}.${cleanWord}.${outputFormat}`;
            const savePath = `assets/${filename}`;

            // Call backend to generate and save
            const response = await fetch('generate.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiKey,
                    voiceId,
                    model,
                    stability,
                    similarity,
                    outputFormat,
                    text: item.word,
                    filename,
                    savePath,
                    type: 'word',
                    cardNum: item.cardNum,
                    lang: item.lang
                })
            });

            return await response.json();
        }

        async function generateSelectedSentences() {
            if (isProcessing) {
                log('Already processing, please wait...', 'error');
                return;
            }

            if (selectedSentences.size === 0) {
                log('No sentences selected', 'error');
                return;
            }

            const apiKey = document.getElementById('apiKey').value.trim();
            const voiceId = document.getElementById('voiceSelect').value;

            if (!apiKey || !voiceId) {
                log('Please configure API key and voice', 'error');
                return;
            }

            isProcessing = true;
            showProgress(true);

            const sentenceList = [];
            const lang = document.getElementById('sentLang').value;

            // Gather sentence data
            selectedSentences.forEach(uniqueId => {
                const [sentLang, lesson, seqIdx, sentIdx] = uniqueId.split('-');
                const lessonData = manifest.sentenceReview[sentLang]?.lessons?.[lesson];
                if (lessonData?.sequences?.[seqIdx]?.sentences?.[sentIdx]) {
                    const sent = lessonData.sequences[seqIdx].sentences[sentIdx];
                    sentenceList.push({
                        lang: sentLang,
                        lesson,
                        text: sent.text,
                        id: sent.id || sentIdx,
                        uniqueId
                    });
                }
            });

            log(`Starting batch generation for ${sentenceList.length} sentences...`, 'info');

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < sentenceList.length; i++) {
                const item = sentenceList[i];
                updateProgress(i + 1, sentenceList.length, `Processing sentence ${i + 1}`);

                try {
                    const result = await generateSentenceAudio(item, apiKey, voiceId);
                    if (result.success) {
                        successCount++;
                        log(`Generated: "${item.text.substring(0, 30)}..." -> ${result.filename}`, 'success');
                    } else {
                        errorCount++;
                        log(`Failed: "${item.text.substring(0, 30)}..." - ${result.error}`, 'error');
                    }
                } catch (error) {
                    errorCount++;
                    log(`Error: ${error.message}`, 'error');
                }

                // Rate limit delay
                if (i < sentenceList.length - 1) {
                    await sleep(1000);
                }
            }

            showProgress(false);
            isProcessing = false;
            log(`Batch complete: ${successCount} success, ${errorCount} errors`, successCount > 0 ? 'success' : 'error');
        }

        async function generateSentenceAudio(item, apiKey, voiceId) {
            const model = document.getElementById('modelSelect').value;
            const stability = parseFloat(document.getElementById('stability').value);
            const similarity = parseFloat(document.getElementById('similarity').value);
            const outputFormat = document.getElementById('outputFormat').value;

            // Generate filename for sentence
            const filename = `lesson${item.lesson}-sent${item.id}.${outputFormat}`;
            const savePath = `assets/sentences/audio/${item.lang}/${filename}`;

            const response = await fetch('generate.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiKey,
                    voiceId,
                    model,
                    stability,
                    similarity,
                    outputFormat,
                    text: item.text,
                    filename,
                    savePath,
                    type: 'sentence',
                    lang: item.lang
                })
            });

            return await response.json();
        }

        async function generateCustom() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const voiceId = document.getElementById('voiceSelect').value;
            const text = document.getElementById('customText').value.trim();
            const filename = document.getElementById('customFilename').value.trim();
            const lang = document.getElementById('customLang').value;

            if (!apiKey || !voiceId) {
                log('Please configure API key and voice', 'error');
                return;
            }

            if (!text) {
                log('Please enter text to synthesize', 'error');
                return;
            }

            if (!filename) {
                log('Please enter a filename', 'error');
                return;
            }

            const model = document.getElementById('modelSelect').value;
            const stability = parseFloat(document.getElementById('stability').value);
            const similarity = parseFloat(document.getElementById('similarity').value);
            const outputFormat = document.getElementById('outputFormat').value;

            const fullFilename = `${filename}.${outputFormat}`;
            const savePath = lang
                ? `assets/sentences/audio/${lang}/${fullFilename}`
                : `assets/${fullFilename}`;

            log(`Generating custom audio: "${text.substring(0, 50)}..."`, 'info');

            try {
                const response = await fetch('generate.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey,
                        voiceId,
                        model,
                        stability,
                        similarity,
                        outputFormat,
                        text,
                        filename: fullFilename,
                        savePath,
                        type: 'custom'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const actualPath = result.savePath || savePath;
                    const formatNote = result.format !== outputFormat ? ` (saved as ${result.format})` : '';
                    log(`Success! Saved to: ${actualPath}${formatNote}`, 'success');

                    // Show preview
                    const preview = document.getElementById('customPreview');
                    preview.innerHTML = `
                        <p><strong>Saved:</strong> ${actualPath}${formatNote}</p>
                        <audio controls src="../${actualPath}?t=${Date.now()}"></audio>
                    `;
                } else {
                    log(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
